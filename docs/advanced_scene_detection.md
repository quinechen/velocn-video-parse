# 高级场景检测算法说明

## 概述

针对视频中高级转场特效（如主体不变但背景变化、渐变转场等），实现了多维度场景检测算法，能够更准确地识别场景切换点。

## 问题背景

传统场景检测算法主要基于：
- 直方图差异
- 像素差异

这些方法在处理以下情况时存在局限性：
1. **主体不变但背景变化**：人物主体位置和姿态不变，但背景完全改变
2. **渐变转场**：使用淡入淡出、溶解等特效的转场
3. **颜色渐变**：背景颜色逐渐变化
4. **复杂视觉效果**：多层叠加、蒙版等效果

## 解决方案

### 多维度差异计算

采用**5种方法组合**，加权计算最终差异度：

```
最终差异 = 区域差异 × 25% + 边缘差异 × 25% + HSV差异 × 20% + 梯度差异 × 15% + 传统差异 × 15%
```

## 详细算法

### 1. 区域分割分析（权重 25%）

**目标**：区分中心区域（主体）和边缘区域（背景），检测背景变化

**算法**：
```
1. 定义区域：
   - 中心区域：图像 30%-70% 的位置（占图像面积约40%）
   - 边缘区域：图像的其他部分（占图像面积约60%）

2. 分别计算差异：
   - 中心区域差异：center_diff
   - 边缘区域差异：edge_diff

3. 判断场景类型：
   - 如果 edge_diff > center_diff × 1.5：
     → 背景变化明显，可能是"主体不变但背景变化"
     → 差异分数 = edge_diff × 0.7 + center_diff × 0.3
   - 否则：
     → 整体变化
     → 差异分数 = (edge_diff + center_diff) / 2
```

**优势**：
- ✅ 能检测主体不变但背景变化的情况
- ✅ 减少主体运动对检测的影响
- ✅ 对背景切换敏感

**代码位置**：`scene_detector.rs::calculate_region_difference()`

### 2. 边缘检测差异（权重 25%）

**目标**：使用Sobel算子检测边缘，比较边缘信息变化

**算法**：
```
1. 使用Sobel算子计算边缘强度：
   - Sobel X: [-1, 0, 1; -2, 0, 2; -1, 0, 1]
   - Sobel Y: [-1, -2, -1; 0, 0, 0; 1, 2, 1]
   - 边缘强度 = sqrt(gx² + gy²)

2. 对每个像素计算边缘强度差异：
   - edge_diff = |edge1 - edge2|

3. 归一化差异：
   - 差异分数 = edge_diff_sum / (像素数 × 最大边缘强度)
```

**优势**：
- ✅ 边缘变化更能反映场景切换
- ✅ 对渐变转场敏感（边缘逐渐变化）
- ✅ 捕捉结构变化

**代码位置**：`scene_detector.rs::calculate_edge_difference()`

### 3. HSV颜色空间分析（权重 20%）

**目标**：在HSV颜色空间中分析，比较色调和饱和度的变化

**算法**：
```
1. RGB转HSV：
   - H (色调): 0-360度
   - S (饱和度): 0-1
   - V (亮度): 0-1

2. 计算差异（采样计算，每2个像素采样一次）：
   - 色调差异：考虑色环的循环性
     * 如果 |h1 - h2| > 180°，则 diff = 360° - |h1 - h2|
     * 归一化到 0-1
   - 饱和度差异：|s1 - s2|
   - 亮度差异：|v1 - v2|

3. 加权组合：
   - 差异分数 = 色调差异 × 0.5 + 饱和度差异 × 0.3 + 亮度差异 × 0.2
```

**优势**：
- ✅ 色调和饱和度变化更能反映场景切换
- ✅ 对背景颜色变化敏感
- ✅ 能检测颜色渐变

**代码位置**：`scene_detector.rs::calculate_hsv_difference()`

### 4. 梯度分析（权重 15%）

**目标**：计算图像梯度，比较梯度分布的变化

**算法**：
```
1. 计算梯度（使用差分算子）：
   - gx = img[x+1, y] - img[x-1, y]
   - gy = img[x, y+1] - img[x, y-1]
   - 梯度强度 = sqrt(gx² + gy²)

2. 计算梯度差异：
   - gradient_diff = |grad1 - grad2|

3. 归一化：
   - 差异分数 = gradient_diff_sum / (像素数 × 255 × √2)
```

**优势**：
- ✅ 捕捉图像结构变化
- ✅ 对细节变化敏感

**代码位置**：`scene_detector.rs::calculate_gradient_difference()`

### 5. 传统方法（权重 15%）

**目标**：作为基础参考，保持向后兼容

**算法**：
```
1. 直方图差异（60%）：
   - 构建256级灰度直方图
   - 计算差异：diff = Σ |hist1[i] - hist2[i]| / 2

2. 像素差异（40%）：
   - 逐像素比较：diff = Σ |pixel1 - pixel2| / (总像素数 × 255)

3. 组合：
   - 传统差异 = 直方图差异 × 0.6 + 像素差异 × 0.4
```

**优势**：
- ✅ 保持对传统场景切换的检测能力
- ✅ 作为基础参考

**代码位置**：`scene_detector.rs::calculate_histogram_difference()` 和 `calculate_pixel_difference()`

## 性能优化

1. **采样计算**：
   - HSV分析：每2个像素采样一次
   - 减少计算量，保持合理性能

2. **区域分割**：
   - 只计算一次区域差异
   - 避免重复计算

3. **边缘检测优化**：
   - 使用简化的Sobel算子
   - 只计算内部像素（避免边界处理）

## 适用场景

### ✅ 能很好处理的场景

1. **主体不变但背景变化**
   - 区域分割分析能检测到背景变化
   - 边缘检测和HSV分析捕捉背景细节变化

2. **渐变转场**
   - 边缘检测对渐变敏感
   - HSV分析检测颜色渐变

3. **颜色渐变**
   - HSV分析专门针对颜色变化
   - 色调和饱和度变化能准确反映

4. **复杂视觉效果**
   - 多维度组合，综合判断
   - 不同方法捕捉不同方面的变化

5. **传统场景切换**
   - 传统方法保持检测能力
   - 多维度组合提高准确性

### ⚠️ 可能存在的局限性

1. **计算复杂度**：
   - 相比传统方法，计算量增加约3-4倍
   - 通过采样和优化保持合理性能

2. **参数调优**：
   - 权重分配可能需要根据视频类型调整
   - 阈值设置需要根据实际效果调整

## 参数说明

### 可配置参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `threshold` | 0.3 | 场景变化阈值 |
| `min_scene_duration` | 1.0秒 | 最小场景持续时间 |

### 固定参数（算法内部）

| 参数 | 值 | 说明 |
|------|-----|------|
| 区域分割权重 | 25% | 区域差异在最终差异中的权重 |
| 边缘检测权重 | 25% | 边缘差异在最终差异中的权重 |
| HSV分析权重 | 20% | HSV差异在最终差异中的权重 |
| 梯度分析权重 | 15% | 梯度差异在最终差异中的权重 |
| 传统方法权重 | 15% | 传统差异在最终差异中的权重 |
| 中心区域范围 | 30%-70% | 中心区域（主体）的位置范围 |
| HSV采样率 | 每2像素 | HSV分析的采样间隔 |

## 使用示例

```rust
use video_parse::SceneDetector;

// 创建场景检测器
let detector = SceneDetector::new(0.3, 1.0);

// 检测场景变化
let scene_changes = detector.detect_scenes(&frames, fps)?;

// 场景变化点已自动使用高级算法计算差异
```

## 未来改进方向

1. **自适应权重**：
   - 根据视频内容动态调整权重
   - 不同类型视频使用不同权重组合

2. **深度学习**：
   - 使用预训练模型进行场景检测
   - 提高对复杂转场的识别能力

3. **光流分析**：
   - 分析运动向量
   - 检测相机运动和物体运动

4. **特征点匹配**：
   - 使用SIFT/ORB特征点
   - 比较特征点分布变化

5. **多尺度分析**：
   - 在不同分辨率下分析
   - 捕捉不同尺度的变化

## 总结

高级场景检测算法通过多维度分析，能够更准确地识别各种类型的场景切换，特别是：
- ✅ 主体不变但背景变化
- ✅ 渐变转场
- ✅ 颜色渐变
- ✅ 复杂视觉效果

同时保持对传统场景切换的检测能力，提高了算法的通用性和准确性。

